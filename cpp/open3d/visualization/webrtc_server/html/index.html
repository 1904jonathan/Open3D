<html>
  <head>
    <title>WebRTC Streamer</title>
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <script src="libs/adapter.min.js"></script>
    <script src="webrtcstreamer.js"></script>
    <script>
      /**
       * Global WebRTC configs
       */
      var webRtcOptions = "rtptransport=tcp&timeout=60";

      /**
       * WebRTC connections
       */
      var webRtcServerList = {};

      /**
       * Get the div where to insert a video
       */
      function getContentDiv() {
        var contentDiv = document.getElementById("content");
        return contentDiv;
      }

      /**
       * Init device list
       */
      function onGetMediaList(remoteDeviceList) {
        var deviceList = [];
        if (remoteDeviceList) {
          deviceList.push.apply(deviceList, remoteDeviceList);
        }

        // Create navigation menu
        var urllist = document.getElementById("menu");
        for (var dev in deviceList) {
          var url = deviceList[dev];
          var option = document.createElement("a");
          var videoTag = "video_" + JSON.stringify(url);
          option.url = url;
          option.text = url.video;
          option.id = "nav_" + videoTag;
          option.onclick = function () {
            if (this.className === "active") {
              del(this.url);
            } else {
              add(this.url);
            }
          };
          urllist.appendChild(option);
        }

        var nbVideos = 1;
        var random = deviceList
          .sort(() => 0.5 - Math.random())
          .slice(0, nbVideos);
        random.forEach((stream) => {
          add(stream);
        });
      }

      /**
       * Delete a WebRTC client connection
       */
      function del(url) {
        var videoTag = "video_" + JSON.stringify(url);

        // Disconnect WebRTC connection
        var webrtcServer = webRtcServerList[videoTag];
        if (webrtcServer) {
          webrtcServer.disconnect();
          webRtcServerList[videoTag] = undefined;
        }
      }

      /**
       * Add a WebRTC client connection
       */
      function add(url) {
        // url = {video: "window_1"}
        var videoTag = "video_" + JSON.stringify(url);
        var windowUID = url.video;

        // Add a video element to display WebRTC stream
        if (document.getElementById(videoTag) === null) {
          var contentDiv = getContentDiv();
          if (contentDiv) {
            var divElt = document.createElement("div");
            divElt.id = "div_" + videoTag;
            var nameElt = document.createElement("h2");
            nameElt.id = "title_" + videoTag;
            nameElt.innerHTML = "<div>" + windowUID + "</div>";
            divElt.appendChild(nameElt);
            var videoElt = document.createElement("video");
            videoElt.id = videoTag;
            videoElt.title = windowUID;
            videoElt.muted = true;
            videoElt.controls = false;
            videoElt.playsinline = true;
            divElt.appendChild(videoElt);
            contentDiv.appendChild(divElt);
          }
        }

        var videoElt = document.getElementById(videoTag);
        if (videoElt) {
          var onClose = function () {
            console.log("onClose() called for videoTag:", videoTag);

            // Remove the video element and its tile
            var divElt = document.getElementById("div_" + videoTag);
            divElt.parentElement.removeChild(divElt);

            // Un-highlight the navigation
            var navElt = document.getElementById("nav_" + videoTag);
            navElt.className = "";
          };

          // Connect video element to webrtc stream
          var webRtcClient = new WebRtcStreamer(videoTag, "", onClose, null);
          console.log("videoTag: " + videoTag);

          webRtcClient.connect(url.video, url.audio, webRtcOptions);
          console.log("url.video: " + url.video);
          console.log("options: " + webRtcOptions);

          // Highlight the navigation
          var navElt = document.getElementById("nav_" + videoTag);
          navElt.className = "active";

          // Register webrtc streamer connection
          webRtcServerList[videoTag] = webRtcClient;
        }
      }

      /**
       * Load/unload callbacks
       */
      window.onload = function () {
        WebRtcStreamer.getMediaList()
          .then((response) => response.json())
          .then((response) => onGetMediaList(response));
      };
      window.onbeforeunload = function () {
        for (var url in webRtcServerList) {
          webRtcServerList[url].disconnect();
        }
      };
    </script>
  </head>

  <body>
    <nav id="menu"></nav>
    <div id="content"></div>
    <footer id="footer"></footer>
  </body>
</html>
