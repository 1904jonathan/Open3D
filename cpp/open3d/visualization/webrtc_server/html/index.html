<html>
  <head>
    <title>Open3D WebVisualizer</title>
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <link rel="icon" type="image/ico" href="open3d_logo.ico" />
    <script src="libs/adapter.min.js"></script>
    <script src="webrtcstreamer.js"></script>
    <script>
      /**
       * Global WebRTC configs
       */
      var webRtcOptions = "rtptransport=tcp&timeout=60";

      /**
       * WebRTC connections
       */
      var webRtcServerList = {};

      /**
       * Get the div where to insert a video
       */
      function getContentDiv() {
        var contentDiv = document.getElementById("content");
        return contentDiv;
      }

      /**
       * Init device list
       * @param {object} mediaList A map of media. E.g.
       * mediaList = {
       *  0: {video: "window_0"},
       *  1: {video: "window_1"},
       * }
       */
      function onGetMediaList(mediaList) {
        // Create navigation menu
        var urlList = document.getElementById("menu");
        for (var key in mediaList) {
          var url = mediaList[key]; // e.g. url = {video: "window_0"}.
          var menuEntry = document.createElement("a");
          var videoTag = "video_" + JSON.stringify(url);
          menuEntry.url = url;
          menuEntry.text = url.video;
          menuEntry.id = "nav_" + videoTag;
          menuEntry.onclick = function () {
            if (this.className === "active") {
              del(this.url);
            } else {
              add(this.url);
            }
          };
          urlList.appendChild(menuEntry);
        }

        mediaList.forEach((url) => {
          add(url);
        });
      }

      /**
       * Delete a WebRTC client connection
       */
      function del(url) {
        var videoTag = "video_" + JSON.stringify(url);

        // Disconnect WebRTC connection
        var webrtcServer = webRtcServerList[videoTag];
        if (webrtcServer) {
          webrtcServer.disconnect();
          webRtcServerList[videoTag] = undefined;
        }
      }

      /**
       * Add a WebRTC client connection
       */
      function add(url) {
        // url = {video: "window_1"}
        var videoTag = "video_" + JSON.stringify(url);
        var windowUID = url.video;

        // Add a video element to display WebRTC stream
        if (document.getElementById(videoTag) === null) {
          var contentDiv = getContentDiv();
          if (contentDiv) {
            var divElt = document.createElement("div");
            divElt.id = "div_" + videoTag;

            var nameElt = document.createElement("h2");
            nameElt.id = "title_" + videoTag;
            nameElt.innerHTML = "<div>" + windowUID + "</div>";
            divElt.appendChild(nameElt);

            var videoElt = document.createElement("video");
            videoElt.id = videoTag;
            videoElt.title = windowUID;
            videoElt.muted = true;
            videoElt.controls = false;
            videoElt.playsinline = true;

            divElt.appendChild(videoElt);

            contentDiv.appendChild(divElt);
          }
        }

        var videoElt = document.getElementById(videoTag);
        if (videoElt) {
          var onClose = function () {
            console.log("onClose() called for videoTag:", videoTag);

            // Remove the video element and its tile
            var divElt = document.getElementById("div_" + videoTag);
            divElt.parentElement.removeChild(divElt);

            // Un-highlight the navigation
            var navElt = document.getElementById("nav_" + videoTag);
            navElt.className = "";
          };

          // Connect video element to WebRTC stream
          var webRtcClient = new WebRtcStreamer(videoTag, "", onClose, null);
          console.log("videoTag: " + videoTag);

          webRtcClient.connect(url.video, url.audio, webRtcOptions);
          console.log("url.video: " + url.video);
          console.log("options: " + webRtcOptions);

          // Highlight the navigation
          var navElt = document.getElementById("nav_" + videoTag);
          navElt.className = "active";

          // Register WebRTC streamer connection
          webRtcServerList[videoTag] = webRtcClient;
        }
      }

      /**
       * Load/unload callbacks
       */
      window.onload = function () {
        WebRtcStreamer.getMediaList()
          .then((response) => response.json())
          .then((response) => onGetMediaList(response));
      };
      window.onbeforeunload = function () {
        for (var url in webRtcServerList) {
          webRtcServerList[url].disconnect();
        }
      };
    </script>
  </head>

  <body>
    <nav id="menu"></nav>
    <div id="content"></div>
    <footer id="footer"></footer>
  </body>
</html>
