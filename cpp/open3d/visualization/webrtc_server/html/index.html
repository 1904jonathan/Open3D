<html>
  <head>
    <title>WebRTC Streamer</title>
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <script src="libs/adapter.min.js"></script>
    <script src="webrtcstreamer.js"></script>
    <script>
      // WebRTC configs
      var webrtcConfig = {
        url: "",
        options: "rtptransport=tcp&timeout=60",
        layoutextraoptions: "&width=320&height=0",
      };

      // ------------------------------------------
      // WebRTC connections
      // ------------------------------------------
      var webRtcServerList = {};

      // ------------------------------------------
      // Decode URL arguments
      // ------------------------------------------
      var argurl = { video: location.search.slice(1) };
      var argoptions = null;
      var layout = null;
      if (typeof URLSearchParams != "undefined") {
        var params = new URLSearchParams(location.search);
        argurl = { video: params.get("video"), audio: params.get("audio") };
        argoptions = params.get("options");
        if (!argoptions) {
          argoptions = webrtcConfig.options;
        }
        layout = params.get("layout");
      } else {
        console.log(
          "URLSearchParams not supported then no argument could be used"
        );
      }

      // ------------------------------------------
      // Get the div where to insert a video
      // ------------------------------------------
      function getContentDiv() {
        var contentDiv = null;
        if (document.getElementById("layout")) {
          var divList = document.getElementsByTagName("div");
          for (var i = 0; i < divList.length; i++) {
            if (divList[i].childNodes.length == 0) {
              contentDiv = divList[i];
              break;
            }
          }
        } else {
          contentDiv = document.getElementById("content");
        }
        return contentDiv;
      }

      // ------------------------------------------
      // Init device list
      // ------------------------------------------
      function onGetDeviceList(remoteDeviceList) {
        var deviceList = [];
        if (argurl.video) {
          deviceList.push(argurl);
        }
        if (remoteDeviceList) {
          deviceList.push.apply(deviceList, remoteDeviceList);
        }

        // create navigation menu
        var urllist = document.getElementById("menu");
        for (var dev in deviceList) {
          var url = deviceList[dev];
          var option = document.createElement("a");
          var videoTag = "video_" + JSON.stringify(url);
          option.url = url;
          option.text = url.video;
          option.id = "nav_" + videoTag;
          option.onclick = function () {
            if (this.className === "active") {
              del(this.url);
            } else {
              add(this.url);
            }
          };
          urllist.appendChild(option);
        }

        if (argurl.video) {
          add(argurl);
        } else {
          var nbVideos = 1;
          if (layout) {
            var splitLayout = layout.split("x");
            var nbrow = parseInt(splitLayout[0]);
            var nbcol = parseInt(splitLayout[1]);
            nbVideos = nbrow * nbcol;
          }
          var random = deviceList
            .sort(() => 0.5 - Math.random())
            .slice(0, nbVideos);
          random.forEach((stream) => {
            add(stream);
          });
        }
      }

      // ------------------------------------------
      // Add a webrtc client connection
      // ------------------------------------------
      function del(url) {
        var videoTag = "video_" + JSON.stringify(url);

        // disconnect webrtc connection
        var webrtcServer = webRtcServerList[videoTag];
        if (webrtcServer) {
          webrtcServer.disconnect();
          webRtcServerList[videoTag] = undefined;
        }

        // remove the video element and its tile
        var divElt = document.getElementById("div_" + videoTag);
        divElt.parentElement.removeChild(divElt);

        // unhighlight the navigation
        var navElt = document.getElementById("nav_" + videoTag);
        navElt.className = "";
      }

      function getModifiers(event) {
        // See open3d/visualization/gui/Events.h.
        var modNone = 0;
        var modShift = 1 << 0;
        var modCtrl = 1 << 1;
        var modAlt = 1 << 2;
        var modMeta = 1 << 3;
        var mod = modNone;
        if (event.getModifierState("Shift")) {
          mod = mod | modShift;
        }
        if (event.getModifierState("Control")) {
          mod = mod | modCtrl;
        }
        if (event.getModifierState("Alt")) {
          mod = mod | modAlt;
        }
        if (event.getModifierState("Meta")) {
          mod = mod | modMeta;
        }
        return mod;
      }

      // ------------------------------------------
      // add a webrtc client connection
      // ------------------------------------------
      function add(url) {
        // url = {video: "window_1"}
        var videoTag = "video_" + JSON.stringify(url);
        var windowUID = url.video;

        // add a video element to display webrtc stream
        if (document.getElementById(videoTag) === null) {
          var contentDiv = getContentDiv();
          if (contentDiv) {
            var divElt = document.createElement("div");
            divElt.id = "div_" + videoTag;
            var nameElt = document.createElement("h2");
            nameElt.id = "title_" + videoTag;
            nameElt.innerHTML = "<div>" + windowUID + "</div>";
            divElt.appendChild(nameElt);
            var videoElt = document.createElement("video");
            videoElt.id = videoTag;
            videoElt.title = windowUID;
            videoElt.muted = true;
            videoElt.controls = false;
            videoElt.playsinline = true;
            divElt.appendChild(videoElt);
            contentDiv.appendChild(divElt);
          }
        }

        var videoElt = document.getElementById(videoTag);
        if (videoElt) {
          // connect video element to webrtc stream
          var webRtcClient = new WebRtcStreamer(videoTag, webrtcConfig.url);
          console.log("videoTag: " + videoTag);
          console.log("webrtcConfig.url: " + webrtcConfig.url);

          var options = argoptions;
          if (layout) {
            options += webrtcConfig.layoutextraoptions;
          }

          webRtcClient.connect(url.video, url.audio, options);
          console.log("url.video: " + url.video);
          console.log("options: " + options);

          // highlight the navigation
          var navElt = document.getElementById("nav_" + videoTag);
          navElt.className = "active";

          // register webrtc streamer connection
          webRtcServerList[videoTag] = webRtcClient;

          // Register callbacks for videoElt.
          videoElt.addEventListener("mousedown", (event) => {
            var open3dMouseEvent = {
              window_uid: windowUID,
              class_name: "MouseEvent",
              type: "BUTTON_DOWN",
              x: event.offsetX,
              y: event.offsetY,
              modifiers: getModifiers(event),
              button: {
                button: "LEFT", // Fix me.
                count: 1,
              },
            };
            webRtcClient.dataChannel.send(JSON.stringify(open3dMouseEvent));
          });
          videoElt.addEventListener("mouseup", (event) => {
            var open3dMouseEvent = {
              window_uid: windowUID,
              class_name: "MouseEvent",
              type: "BUTTON_UP",
              x: event.offsetX,
              y: event.offsetY,
              modifiers: getModifiers(event),
              button: {
                button: "LEFT", // Fix me.
                count: 1,
              },
            };
            webRtcClient.dataChannel.send(JSON.stringify(open3dMouseEvent));
          });
          videoElt.addEventListener("mousemove", (event) => {
            // TODO: Known differences. Currently only left-key drag works.
            // - Open3D: L=1, M=2, R=4
            // - JavaScript: L=1, R=2, M=4
            var open3dMouseEvent = {
              window_uid: windowUID,
              class_name: "MouseEvent",
              type: event.buttons == 0 ? "MOVE" : "DRAG",
              x: event.offsetX,
              y: event.offsetY,
              modifiers: getModifiers(event),
              move: {
                buttons: event.buttons, // MouseButtons ORed together
              },
            };
            webRtcClient.dataChannel.send(JSON.stringify(open3dMouseEvent));
          });
          videoElt.addEventListener("mouseleave", (event) => {
            var open3dMouseEvent = {
              window_uid: windowUID,
              class_name: "MouseEvent",
              type: "BUTTON_UP",
              x: event.offsetX,
              y: event.offsetY,
              modifiers: getModifiers(event),
              button: {
                button: "LEFT", // Fix me.
                count: 1,
              },
            };
            webRtcClient.dataChannel.send(JSON.stringify(open3dMouseEvent));
          });
          videoElt.addEventListener(
            "wheel",
            (event) => {
              // Prevent propagating the wheel event to the browser.
              // https://stackoverflow.com/a/23606063/1255535
              event.preventDefault();

              // https://stackoverflow.com/a/56948026/1255535.
              var isTrackpad = event.wheelDeltaY
                ? event.wheelDeltaY === -3 * event.deltaY
                : event.deltaMode === 0;

              // TODO: set better scaling.
              // Flip the sign and set abaolute value to 1.
              var dx = event.deltaX;
              var dy = event.deltaY;
              dx = dx == 0 ? dx : (-dx / Math.abs(dx)) * 1;
              dy = dy == 0 ? dy : (-dy / Math.abs(dy)) * 1;

              var open3dMouseEvent = {
                window_uid: windowUID,
                class_name: "MouseEvent",
                type: "WHEEL",
                x: event.offsetX,
                y: event.offsetY,
                modifiers: getModifiers(event),
                wheel: {
                  dx: dx,
                  dy: dy,
                  isTrackpad: isTrackpad ? 1 : 0,
                },
              };
              webRtcClient.dataChannel.send(JSON.stringify(open3dMouseEvent));
            },
            { passive: false }
          );
        }
      }

      // ------------------------------------------
      // load/unload callbacks
      // ------------------------------------------
      window.onload = function () {
        if (layout) {
          var splitLayout = layout.split("x");
          var nbrow = parseInt(splitLayout[0]);
          var nbcol = parseInt(splitLayout[1]);
          var tableelt = document.createElement("table");
          tableelt.id = "layout";
          for (var irow = 0; irow < nbrow; irow++) {
            var row = tableelt.insertRow(0);
            for (var icol = 0; icol < nbcol; icol++) {
              row.insertCell(0).appendChild(document.createElement("div"));
            }
          }
          document.getElementById("content").appendChild(tableelt);
        }

        fetch(webrtcConfig.url + "/api/getMediaList")
          .then((response) => response.json())
          .then((response) => onGetDeviceList(response));
      };
      window.onbeforeunload = function () {
        for (var url in webRtcServerList) {
          webRtcServerList[url].disconnect();
        }
      };
    </script>
  </head>

  <body>
    <nav id="menu"></nav>
    <div id="content"></div>
    <footer id="footer"></footer>
  </body>
</html>
