#include "open3d/pipelines/mesh_reconstruction/TriangleMeshReconstruction.h"
#include "tests/UnitTest.h"

namespace open3d {
namespace tests {

TEST(TriangleMeshReconstructionPoisson, ReconstructPoisson) {
    geometry::PointCloud pcd;
    pcd.points_ = {
            {-0.215279, 0.121252, 0.965784},  {0.079266, 0.643799, 0.755848},
            {0.001534, -0.691225, 0.720568},  {0.663793, 0.567055, 0.478929},
            {-0.929397, -0.262081, 0.238929}, {0.741441, -0.628480, 0.209423},
            {-0.844085, 0.510828, 0.131410},  {0.001478, -0.999346, 0.006834},
            {-0.075616, 0.987936, -0.077669}, {-0.599516, -0.738522, -0.297292},
            {0.952159, -0.061734, -0.284187}, {0.616751, -0.543117, -0.562931},
            {-0.066283, 0.653032, -0.748836}, {0.408743, 0.133839, -0.900872},
            {-0.165481, -0.187750, -0.964982}};
    pcd.normals_ = {
            {-0.227789, 0.134744, 0.961608},  {0.084291, 0.646929, 0.752716},
            {-0.002898, -0.694359, 0.717585}, {0.666542, 0.565546, 0.476952},
            {-0.930073, -0.260750, 0.237944}, {0.740792, -0.629608, 0.208559},
            {-0.843751, 0.511569, 0.130869},  {0.001436, -0.999352, 0.006806},
            {-0.076095, 0.987987, -0.077349}, {-0.598343, -0.739977, -0.296067},
            {0.952641, -0.060018, -0.283016}, {0.620242, -0.541600, -0.560605},
            {-0.071145, 0.656184, -0.745733}, {0.414599, 0.141599, -0.897109},
            {-0.172774, -0.204293, -0.960815}};
    pcd.colors_ = {
            {0.380208, 0.759545, 0.171340}, {0.288485, 0.063605, 0.643738},
            {0.997344, 0.888908, 0.802631}, {0.249312, 0.621767, 0.718174},
            {0.953116, 0.032469, 0.828249}, {0.763606, 0.914161, 0.458050},
            {0.735258, 0.974643, 0.458129}, {0.985589, 0.649781, 0.064284},
            {0.714224, 0.413067, 0.800399}, {0.433070, 0.962528, 0.138826},
            {0.066043, 0.867413, 0.276809}, {0.321559, 0.662692, 0.011849},
            {0.353338, 0.784374, 0.899556}, {0.248052, 0.431480, 0.339511},
            {0.880225, 0.614243, 0.379607}};
    geometry::TriangleMesh mesh_gt;
    mesh_gt.vertices_ = {{-0.535122, -0.678988, -0.546102},
                         {-0.856971, -0.552207, -0.546102},
                         {0.011381, -0.852840, -0.546102},
                         {-1.081624, -0.478258, -0.546102},
                         {0.557883, -0.571511, -0.546102},
                         {0.576765, -0.552207, -0.546102},
                         {0.739454, -0.005705, -0.546102},
                         {-1.081624, 0.339532, -0.546102},
                         {-0.720499, 0.540798, -0.546102},
                         {-0.535122, 0.637316, -0.546102},
                         {0.011381, 0.788968, -0.546102},
                         {0.559266, 0.540798, -0.546102},
                         {0.557883, 0.542438, -0.546102},
                         {-0.535122, -0.552207, -0.761037},
                         {0.011381, -0.552207, -0.838612},
                         {-1.081624, -0.005705, -1.024482},
                         {-0.535122, -0.005705, -1.038080},
                         {0.011381, -0.005705, -1.001911},
                         {0.557883, -0.552207, -0.565591},
                         {0.557883, -0.005705, -0.755925},
                         {-0.535122, 0.540798, -0.678056},
                         {0.011381, 0.540798, -0.807635},
                         {0.557883, 0.540798, -0.547422},
                         {-0.535122, -0.868303, 0.000401},
                         {-0.957409, -0.552207, 0.000401},
                         {0.011381, -0.981478, 0.000401},
                         {-1.081624, -0.413615, 0.000401},
                         {0.557883, -0.735421, 0.000401},
                         {0.756038, -0.552207, 0.000401},
                         {1.045917, -0.005705, 0.000401},
                         {-1.081624, 0.279246, 0.000401},
                         {-0.856915, 0.540798, 0.000401},
                         {-0.535122, 0.806682, 0.000401},
                         {0.011381, 0.995774, 0.000401},
                         {0.876659, 0.540798, 0.000401},
                         {0.557883, 0.851917, 0.000401},
                         {0.011381, -0.775497, 0.546903},
                         {-0.494233, -0.552207, 0.546903},
                         {-0.535122, -0.513868, 0.546903},
                         {-0.768247, -0.005705, 0.546903},
                         {0.557883, -0.601114, 0.546903},
                         {0.621286, -0.552207, 0.546903},
                         {0.891579, -0.005705, 0.546903},
                         {-0.535122, 0.523186, 0.546903},
                         {-0.516131, 0.540798, 0.546903},
                         {0.011381, 0.784610, 0.546903},
                         {0.613233, 0.540798, 0.546903},
                         {0.557883, 0.585415, 0.546903},
                         {-0.535122, -0.552207, 0.520166},
                         {-1.081624, -0.005705, 0.145186},
                         {-0.535122, 0.540798, 0.529053},
                         {0.011381, -0.552207, 0.785752},
                         {-0.535122, -0.005705, 0.773541},
                         {0.011381, -0.005705, 1.045411},
                         {0.557883, -0.552207, 0.612610},
                         {0.557883, -0.005705, 0.880973},
                         {0.011381, 0.540798, 0.802148},
                         {0.557883, 0.540798, 0.593895}};
    mesh_gt.vertex_normals_ = {{-0.363328, -0.449218, -0.596538},
                               {-0.363328, -0.449218, -0.596538},
                               {-0.363328, -0.449218, -0.596538},
                               {-0.363328, -0.449218, -0.596538},
                               {0.748097, -0.287048, -0.401288},
                               {0.748097, -0.287048, -0.401288},
                               {0.624682, -0.539519, -0.560146},
                               {-0.067839, 0.778945, -0.391656},
                               {-0.067839, 0.778945, -0.391656},
                               {-0.067839, 0.778945, -0.391656},
                               {-0.071381, 0.660859, -0.743014},
                               {0.375628, 0.123591, -0.806610},
                               {0.375628, 0.123591, -0.806610},
                               {-0.363328, -0.449218, -0.596538},
                               {-0.363328, -0.449218, -0.596538},
                               {-0.363328, -0.449218, -0.596538},
                               {-0.363328, -0.449218, -0.596538},
                               {-0.176322, -0.208808, -0.957378},
                               {0.748097, -0.287048, -0.401288},
                               {0.748097, -0.287048, -0.401288},
                               {-0.067839, 0.778945, -0.391656},
                               {-0.067839, 0.778945, -0.391656},
                               {0.414932, 0.141672, -0.897776},
                               {-0.596520, -0.737720, -0.301946},
                               {-0.596520, -0.737720, -0.301946},
                               {-0.363328, -0.449218, -0.596538},
                               {-0.363328, -0.449218, -0.596538},
                               {0.748097, -0.287048, -0.401288},
                               {0.748097, -0.287048, -0.401288},
                               {0.953452, -0.063973, -0.286170},
                               {-0.067839, 0.778945, -0.391656},
                               {-0.067839, 0.778945, -0.391656},
                               {-0.067839, 0.778945, -0.391656},
                               {-0.076419, 0.990524, -0.082928},
                               {0.375628, 0.123591, -0.806610},
                               {0.375628, 0.123591, -0.806610},
                               {-0.005705, -0.991160, 0.013986},
                               {-0.005705, -0.991160, 0.013986},
                               {-0.919808, -0.270837, 0.240837},
                               {-0.919808, -0.270837, 0.240837},
                               {0.670787, -0.570145, 0.185455},
                               {0.744380, -0.632658, 0.209540},
                               {0.670787, -0.570145, 0.185455},
                               {-0.842126, 0.510549, 0.137740},
                               {-0.506191, 0.304790, 0.516282},
                               {-0.506191, 0.304790, 0.516282},
                               {0.358188, 0.573235, 0.581938},
                               {0.358188, 0.573235, 0.581938},
                               {-0.298994, -0.629163, 0.308635},
                               {-0.919808, -0.270837, 0.240837},
                               {-0.842126, 0.510549, 0.137740},
                               {-0.009941, -0.693804, 0.708891},
                               {-0.298994, -0.629163, 0.308635},
                               {-0.298994, -0.629163, 0.308635},
                               {0.670787, -0.570145, 0.185455},
                               {0.670787, -0.570145, 0.185455},
                               {-0.232912, 0.137861, 0.956863},
                               {0.358188, 0.573235, 0.581938}};
    mesh_gt.vertex_colors_ = {
            {0.651185, 0.780322, 0.270666}, {0.651185, 0.780322, 0.270666},
            {0.651185, 0.780322, 0.270666}, {0.651185, 0.780322, 0.270666},
            {0.213958, 0.758281, 0.162138}, {0.213958, 0.758281, 0.162138},
            {0.319808, 0.664247, 0.014295}, {0.535119, 0.601156, 0.828728},
            {0.535119, 0.601156, 0.828728}, {0.535119, 0.601156, 0.828728},
            {0.356296, 0.781393, 0.898403}, {0.280560, 0.453637, 0.352787},
            {0.280560, 0.453637, 0.352787}, {0.651185, 0.780322, 0.270666},
            {0.651185, 0.780322, 0.270666}, {0.651185, 0.780322, 0.270666},
            {0.651185, 0.780322, 0.270666}, {0.876498, 0.616945, 0.377835},
            {0.213958, 0.758281, 0.162138}, {0.213958, 0.758281, 0.162138},
            {0.535119, 0.601156, 0.828728}, {0.535119, 0.601156, 0.828728},
            {0.248333, 0.431672, 0.339626}, {0.436619, 0.959563, 0.140971},
            {0.436619, 0.959563, 0.140971}, {0.651185, 0.780322, 0.270666},
            {0.651185, 0.780322, 0.270666}, {0.213958, 0.758281, 0.162138},
            {0.213958, 0.758281, 0.162138}, {0.068450, 0.865637, 0.274943},
            {0.535119, 0.601156, 0.828728}, {0.535119, 0.601156, 0.828728},
            {0.535119, 0.601156, 0.828728}, {0.711309, 0.416128, 0.800860},
            {0.280560, 0.453637, 0.352787}, {0.280560, 0.453637, 0.352787},
            {0.985049, 0.646890, 0.076101}, {0.985049, 0.646890, 0.076101},
            {0.953348, 0.044255, 0.821904}, {0.953348, 0.044255, 0.821904},
            {0.742035, 0.885688, 0.458892}, {0.763420, 0.913915, 0.458058},
            {0.742035, 0.885688, 0.458892}, {0.732370, 0.972691, 0.455932},
            {0.557746, 0.854674, 0.323112}, {0.557746, 0.854674, 0.323112},
            {0.284898, 0.359292, 0.669062}, {0.284898, 0.359292, 0.669062},
            {0.962866, 0.528193, 0.561334}, {0.953348, 0.044255, 0.821904},
            {0.732370, 0.972691, 0.455932}, {0.996524, 0.880332, 0.796895},
            {0.962866, 0.528193, 0.561334}, {0.962866, 0.528193, 0.561334},
            {0.742035, 0.885688, 0.458892}, {0.742035, 0.885688, 0.458892},
            {0.383097, 0.761093, 0.173810}, {0.284898, 0.359292, 0.669062}};
    mesh_gt.triangles_ = {
            {1, 13, 0},   {0, 14, 2},   {13, 14, 0},  {1, 15, 13},
            {15, 16, 13}, {1, 3, 15},   {14, 13, 16}, {16, 17, 14},
            {2, 18, 4},   {14, 18, 2},  {4, 18, 5},   {18, 14, 17},
            {17, 19, 18}, {18, 19, 6},  {6, 5, 18},   {7, 16, 15},
            {7, 8, 16},   {8, 20, 16},  {21, 16, 20}, {17, 16, 21},
            {9, 20, 8},   {10, 20, 9},  {21, 20, 10}, {22, 17, 21},
            {19, 17, 22}, {19, 22, 11}, {11, 6, 19},  {22, 21, 10},
            {10, 12, 22}, {11, 22, 12}, {24, 0, 23},  {1, 0, 24},
            {0, 2, 25},   {25, 23, 0},  {3, 1, 24},   {24, 26, 3},
            {2, 4, 27},   {27, 25, 2},  {27, 5, 28},  {4, 5, 27},
            {28, 6, 29},  {5, 6, 28},   {8, 7, 30},   {30, 31, 8},
            {32, 8, 31},  {9, 8, 32},   {33, 9, 32},  {10, 9, 33},
            {6, 11, 34},  {34, 29, 6},  {12, 10, 33}, {33, 35, 12},
            {34, 12, 35}, {11, 12, 34}, {24, 23, 48}, {36, 23, 25},
            {36, 37, 23}, {37, 48, 23}, {38, 24, 48}, {38, 39, 24},
            {39, 26, 24}, {39, 49, 26}, {38, 48, 37}, {25, 27, 40},
            {40, 36, 25}, {27, 28, 41}, {41, 40, 27}, {28, 29, 42},
            {42, 41, 28}, {39, 30, 49}, {39, 31, 30}, {39, 50, 31},
            {39, 43, 50}, {44, 50, 43}, {32, 31, 50}, {44, 32, 50},
            {44, 45, 32}, {45, 33, 32}, {42, 34, 46}, {29, 34, 42},
            {47, 33, 45}, {35, 33, 47}, {34, 35, 47}, {47, 46, 34},
            {37, 36, 51}, {39, 38, 52}, {53, 52, 51}, {52, 37, 51},
            {52, 38, 37}, {36, 40, 54}, {54, 51, 36}, {54, 40, 41},
            {51, 54, 55}, {55, 53, 51}, {55, 41, 42}, {54, 41, 55},
            {43, 39, 52}, {56, 52, 53}, {56, 44, 52}, {44, 43, 52},
            {45, 44, 56}, {56, 55, 57}, {53, 55, 56}, {55, 42, 46},
            {46, 57, 55}, {45, 56, 57}, {57, 47, 45}, {57, 46, 47}};
    std::vector<double> densities_gt = {
            0.39865168929100037, 0.32580316066741943, 0.39778709411621094,
            0.2200755625963211,  0.428702175617218,   0.4288075268268585,
            0.44350555539131165, 0.24208465218544006, 0.3794262409210205,
            0.407772421836853,   0.41914406418800354, 0.4330996870994568,
            0.4330378770828247,  0.3689049780368805,  0.4012255072593689,
            0.07905912399291992, 0.30074167251586914, 0.3844510018825531,
            0.4286557137966156,  0.43353089690208435, 0.3970388174057007,
            0.41389259696006775, 0.4331146478652954,  0.39110293984413147,
            0.3399316370487213,  0.3989846110343933,  0.294955313205719,
            0.44293972849845886, 0.4377133548259735,  0.36585745215415955,
            0.31271663308143616, 0.3885934352874756,  0.4121553897857666,
            0.3849177360534668,  0.3899257779121399,  0.3932742774486542,
            0.42859214544296265, 0.44281646609306335, 0.4422561824321747,
            0.4249078631401062,  0.4210644066333771,  0.41715115308761597,
            0.38326939940452576, 0.43757864832878113, 0.4378965198993683,
            0.42082998156547546, 0.41933944821357727, 0.42220038175582886,
            0.439664751291275,   0.3250156342983246,  0.437633752822876,
            0.4227336645126343,  0.42734524607658386, 0.35958021879196167,
            0.41651853919029236, 0.3831002116203308,  0.41637951135635376,
            0.42157289385795593};

    std::shared_ptr<geometry::TriangleMesh> mesh_es;
    std::vector<double> densities_es;
    std::tie(mesh_es, densities_es) =
            pipelines::mesh_reconstruction::ReconstructPoisson(pcd, 2);

    double threshold = 1e-4;
    ExpectEQ(mesh_es->vertices_, mesh_gt.vertices_, threshold);
    ExpectEQ(mesh_es->vertex_normals_, mesh_gt.vertex_normals_, threshold);
    ExpectEQ(mesh_es->vertex_colors_, mesh_gt.vertex_colors_, threshold);
    ExpectEQ(mesh_es->triangles_, mesh_gt.triangles_);
    ExpectEQ(mesh_es->triangle_normals_, mesh_gt.triangle_normals_, threshold);
    ExpectEQ(densities_es, densities_gt, threshold);
}

}  // namespace tests
}  // namespace open3d
